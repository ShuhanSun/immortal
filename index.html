import React, { useState, useEffect, useRef } from 'react';
import { 
  Scroll, sword, Mountain, Sparkles, FlaskConical, 
  Map as MapIcon, User, Droplets, Swords, Skull, 
  Flame, Wind, Zap, ShoppingBag, Leaf, Hammer
} from 'lucide-react';

// --- 游戏数据常量 ---

const REALMS = [
  { name: "凡人", maxExp: 100, hp: 50, atk: 5 },
  { name: "炼气一层", maxExp: 200, hp: 100, atk: 15 },
  { name: "炼气二层", maxExp: 400, hp: 150, atk: 25 },
  { name: "炼气三层", maxExp: 800, hp: 220, atk: 40 },
  { name: "炼气四层", maxExp: 1500, hp: 300, atk: 60 },
  { name: "炼气五层", maxExp: 2500, hp: 400, atk: 85 },
  { name: "炼气六层", maxExp: 4000, hp: 550, atk: 110 },
  { name: "炼气七层", maxExp: 6000, hp: 700, atk: 140 },
  { name: "炼气八层", maxExp: 9000, hp: 900, atk: 180 },
  { name: "炼气九层", maxExp: 13000, hp: 1200, atk: 230 },
  { name: "炼气十层", maxExp: 18000, hp: 1500, atk: 280 },
  { name: "筑基初期", maxExp: 50000, hp: 5000, atk: 800 },
];

const ITEMS = {
  spiritStone: { name: "灵石", desc: "修仙界的通用货币，也可辅助修炼。", type: "currency" },
  herbSeed: { name: "黄龙草种子", desc: "低阶灵草种子。", type: "material" },
  spiritHerb: { name: "黄龙草", desc: "十年份灵草，炼制黄龙丹的主材。", type: "material" },
  rareHerb: { name: "金髓花", desc: "珍稀灵草，炼制金髓丸的主材。", type: "material" },
  pillQi: { name: "黄龙丹", desc: "精进法力的丹药，增加大量修为。", exp: 50, type: "consumable" },
  pillRare: { name: "金髓丸", desc: "洗髓伐骨，大幅增加修为。", exp: 150, type: "consumable" },
  talismanFire: { name: "火弹符", desc: "封印了火弹术的符箓，威力尚可。", dmg: 50, type: "weapon" },
  ironSword: { name: "铁精剑", desc: "掺入了铁精的法器。", atkBonus: 10, type: "equip" },
  monsterCore: { name: "低阶妖丹", desc: "妖兽的一身精华所在。", type: "material" },
};

const ENEMIES = [
  { name: "野狼", realm: "野兽", hp: 30, atk: 8, exp: 5, loot: null },
  { name: "土甲龙", realm: "一级妖兽", hp: 120, atk: 20, exp: 20, loot: "monsterCore" },
  { name: "双头鹫", realm: "一级顶阶", hp: 300, atk: 45, exp: 50, loot: "monsterCore" },
  { name: "墨蛟", realm: "二级妖兽", hp: 2000, atk: 150, exp: 500, loot: "rareHerb" },
];

// --- 样式组件 ---

const Card = ({ children, className = "", title }) => (
  <div className={`bg-stone-900 border-2 border-amber-800/50 rounded-lg p-4 shadow-xl relative overflow-hidden ${className}`}>
    {title && (
      <div className="absolute top-0 left-0 right-0 bg-amber-900/20 border-b border-amber-800/30 px-3 py-1">
        <h3 className="text-amber-500 font-serif font-bold text-sm tracking-widest">{title}</h3>
      </div>
    )}
    <div className={title ? "mt-6" : ""}>{children}</div>
    {/* 装饰纹理 */}
    <div className="absolute bottom-0 right-0 w-16 h-16 opacity-5 pointer-events-none">
      <svg viewBox="0 0 100 100" fill="currentColor" className="text-amber-500">
        <path d="M50 0 C70 20 80 40 80 50 C80 60 70 80 50 100 C30 80 20 60 20 50 C20 40 30 20 50 0 Z" />
      </svg>
    </div>
  </div>
);

const Button = ({ onClick, disabled, children, variant = "primary", className = "" }) => {
  const baseStyle = "px-4 py-2 rounded font-serif transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-amber-800 hover:bg-amber-700 text-amber-100 border border-amber-600 shadow-[0_2px_0_rgb(120,53,15)]",
    secondary: "bg-stone-800 hover:bg-stone-700 text-stone-300 border border-stone-600",
    danger: "bg-red-900/50 hover:bg-red-800/50 text-red-200 border border-red-800",
    outline: "bg-transparent border border-amber-800/50 text-amber-700 hover:bg-amber-900/10"
  };
  
  return (
    <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
      {children}
    </button>
  );
};

const ProgressBar = ({ value, max, color = "bg-amber-600", label }) => (
  <div className="w-full">
    <div className="flex justify-between text-xs mb-1 text-stone-400 font-serif">
      <span>{label}</span>
      <span>{Math.floor(value)} / {max}</span>
    </div>
    <div className="h-2 bg-stone-800 rounded-full overflow-hidden border border-stone-700">
      <div 
        className={`h-full ${color} transition-all duration-500`} 
        style={{ width: `${Math.min(100, (value / max) * 100)}%` }}
      />
    </div>
  </div>
);

// --- 主程序 ---

export default function CultivationGame() {
  // 玩家状态
  const [player, setPlayer] = useState({
    name: "韩立",
    realmIdx: 0,
    exp: 0,
    hp: 50,
    maxHp: 50,
    gold: 10, // 灵石
    inventory: {
      pillQi: 2,
      herbSeed: 5,
      talismanFire: 3
    }
  });

  // 游戏系统状态
  const [view, setView] = useState("cave"); // cave, garden, alchemy, explore, combat
  const [logs, setLogs] = useState(["欢迎来到凡人修仙传 Origin。你资质平庸，刚刚踏入修仙界。"]);
  const [bottleCharge, setBottleCharge] = useState(0); // 掌天瓶能量
  const [garden, setGarden] = useState([]); // 种植的草药
  const [combatState, setCombatState] = useState(null); // 战斗状态
  const logEndRef = useRef(null);

  // 自动滚动日志
  useEffect(() => {
    logEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [logs]);

  // 掌天瓶充能逻辑 (每秒增加)
  useEffect(() => {
    const timer = setInterval(() => {
      setBottleCharge(prev => Math.min(prev + 1, 100));
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  // 辅助函数：添加日志
  const addLog = (msg) => {
    setLogs(prev => [...prev.slice(-19), `[${new Date().toLocaleTimeString().slice(0,5)}] ${msg}`]);
  };

  // 辅助函数：获得物品
  const gainItem = (key, count = 1) => {
    setPlayer(prev => ({
      ...prev,
      inventory: {
        ...prev.inventory,
        [key]: (prev.inventory[key] || 0) + count
      }
    }));
    addLog(`获得了 ${ITEMS[key].name} x${count}`);
  };

  // 辅助函数：消耗物品
  const consumeItem = (key, count = 1) => {
    if ((player.inventory[key] || 0) < count) return false;
    setPlayer(prev => {
      const newInv = { ...prev.inventory };
      newInv[key] -= count;
      if (newInv[key] <= 0) delete newInv[key];
      return { ...prev, inventory: newInv };
    });
    return true;
  };

  // 动作：修炼
  const meditate = () => {
    if (player.hp < player.maxHp * 0.2) {
      addLog("身体过于虚弱，无法入定修炼。");
      return;
    }
    const gain = Math.floor(Math.random() * 3) + 2; // 资质差，增加少
    const hpRec = Math.floor(player.maxHp * 0.1);
    
    setPlayer(prev => {
      // 检查升级
      let newExp = prev.exp + gain;
      let newRealmIdx = prev.realmIdx;
      let newMaxHp = prev.maxHp;
      let newHp = Math.min(prev.maxHp, prev.hp + hpRec);
      
      const currentRealm = REALMS[prev.realmIdx];
      
      if (newExp >= currentRealm.maxExp) {
        if (prev.realmIdx < REALMS.length - 1) {
          // 这里简化了突破，原著需要筑基丹等，这里暂时自动
           // 实际应该卡瓶颈
           if (prev.realmIdx === 9 && !prev.inventory.pillRare) { // 炼气圆满卡筑基
             addLog("遭遇瓶颈！需服用稀有丹药方可筑基。");
             newExp = currentRealm.maxExp - 1; 
           } else {
             newRealmIdx++;
             newExp = 0;
             newMaxHp = REALMS[newRealmIdx].hp;
             newHp = newMaxHp;
             addLog(`>>> 突破成功！晋升为【${REALMS[newRealmIdx].name}】 <<<`);
           }
        } else {
           newExp = currentRealm.maxExp;
        }
      }
      
      return { ...prev, exp: newExp, realmIdx: newRealmIdx, hp: newHp, maxHp: newMaxHp };
    });
    addLog(`打坐吐纳，恢复了气血，修为略微精进 (+${gain})。`);
  };

  // 动作：服用丹药
  const useItem = (key) => {
    const item = ITEMS[key];
    if (item.type !== "consumable") return;
    
    if (consumeItem(key)) {
      if (item.exp) {
        setPlayer(prev => {
           // 同样的升级逻辑
           let newExp = prev.exp + item.exp;
           // ... 简化 ... 实际上应该复用上面的逻辑
           const currentRealm = REALMS[prev.realmIdx];
           if (newExp >= currentRealm.maxExp && prev.realmIdx < REALMS.length - 1) {
              return { 
                ...prev, 
                realmIdx: prev.realmIdx + 1, 
                exp: 0, 
                maxHp: REALMS[prev.realmIdx + 1].hp,
                hp: REALMS[prev.realmIdx + 1].hp 
              };
           }
           return { ...prev, exp: newExp };
        });
        addLog(`服用了 ${item.name}，腹中升起一股热流，修为大涨 (+${item.exp})！`);
      }
    }
  };

  // 动作：种植
  const plantHerb = () => {
    if (garden.length >= 4) {
      addLog("药园已满，无法开辟更多灵田。");
      return;
    }
    if (consumeItem("herbSeed")) {
      setGarden(prev => [...prev, { name: "幼苗", progress: 0, id: Date.now() }]);
      addLog("在药园种下了一颗种子。");
    } else {
      addLog("缺少种子。");
    }
  };

  // 动作：掌天瓶催熟
  const ripenHerb = (id) => {
    if (bottleCharge < 100) {
      addLog("小瓶上的光点尚未汇聚完全（需100%能量）。");
      return;
    }
    setBottleCharge(0);
    setGarden(prev => prev.map(p => p.id === id ? { ...p, progress: 100, name: "百年灵草" } : p));
    addLog("你滴下一滴绿液，幼苗瞬间疯长，化为百年灵草！");
  };

  // 动作：收获
  const harvestHerb = (id) => {
    setGarden(prev => prev.filter(p => p.id !== id));
    gainItem("spiritHerb", 2);
    addLog("收获了灵草。");
  };

  // 动作：炼丹
  const alchemy = () => {
    if (consumeItem("spiritHerb", 2)) {
      // 成功率
      const success = Math.random() > 0.3;
      if (success) {
        gainItem("pillQi");
        addLog("炉火纯青！炼制出了黄龙丹。");
      } else {
        addLog("火候未掌控好，一炉丹药化为废渣。");
      }
    } else {
      addLog("炼制黄龙丹需要 黄龙草 x2。");
    }
  };

  // 动作：开始探索
  const startExplore = () => {
    const rand = Math.random();
    if (rand < 0.3) {
      // 捡东西
      const itemKeys = Object.keys(ITEMS).filter(k => ITEMS[k].type === "material" || k === "herbSeed");
      const loot = itemKeys[Math.floor(Math.random() * itemKeys.length)];
      gainItem(loot);
      addLog("外出历练，在一处隐秘洞穴发现了一些物资。");
    } else if (rand < 0.8) {
      // 遇敌
      const enemyPool = ENEMIES.filter(e => {
         // 简单的难度过滤
         if(player.realmIdx < 2) return e.name === "野狼";
         if(player.realmIdx < 5) return e.realm.includes("一级");
         return true;
      });
      const enemy = enemyPool[Math.floor(Math.random() * enemyPool.length)] || ENEMIES[0];
      setCombatState({
        enemy: { ...enemy, maxHp: enemy.hp },
        log: [`遭遇了 ${enemy.name} (${enemy.realm})！`],
        turn: 1
      });
      setView("combat");
    } else {
      addLog("四处游历了一番，除了一些凡人村落，一无所获。");
    }
  };

  // 战斗逻辑
  const combatAction = (action) => {
    if (!combatState) return;
    
    let playerDmg = 0;
    let logMsg = "";
    const enemy = combatState.enemy;

    // 玩家回合
    if (action === "attack") {
      playerDmg = REALMS[player.realmIdx].atk;
      // 武器加成
      if (player.inventory.ironSword) playerDmg += 10;
      logMsg = `你驱使法器攻击，造成 ${playerDmg} 点伤害。`;
    } else if (action === "talisman") {
      if (consumeItem("talismanFire")) {
        playerDmg = 50; // 火弹符固定伤害
        logMsg = `你祭出一张火弹符，化为火球轰击，造成 ${playerDmg} 点伤害！`;
      } else {
        logMsg = "你摸遍储物袋，却发现没有符箓了！尴尬地空手挥了一下。";
      }
    } else if (action === "escape") {
      if (Math.random() > 0.5) {
        addLog(`你施展御风术，成功从 ${enemy.name} 手中逃脱。`);
        setCombatState(null);
        setView("explore");
        return;
      } else {
        logMsg = "逃跑失败！被对方缠住了。";
      }
    }

    // 结算玩家伤害
    let newEnemyHp = enemy.hp - playerDmg;
    
    if (newEnemyHp <= 0) {
      // 胜利
      const dropLog = enemy.loot ? `搜刮尸体发现了 ${ITEMS[enemy.loot].name}。` : "";
      if (enemy.loot) gainItem(enemy.loot);
      setPlayer(prev => ({ ...prev, gold: prev.gold + Math.floor(Math.random() * 5) }));
      addLog(`击杀了 ${enemy.name}！${dropLog}`);
      setCombatState(null);
      setView("explore");
      return;
    }

    // 敌人回合
    const enemyDmg = Math.max(1, enemy.atk - (player.realmIdx * 2)); // 简单的防御计算
    let newPlayerHp = player.hp - enemyDmg;
    const enemyLog = `${enemy.name} 发起反击，你受到了 ${enemyDmg} 点伤害。`;

    if (newPlayerHp <= 0) {
      // 死亡
      newPlayerHp = 1;
      addLog("你不敌对手，身受重伤，拼死施展血遁术逃回了洞府。境界大跌！");
      setPlayer(prev => ({ ...prev, hp: 1, realmIdx: Math.max(0, prev.realmIdx - 1), exp: 0 }));
      setCombatState(null);
      setView("cave");
      return;
    } else {
       setPlayer(prev => ({ ...prev, hp: newPlayerHp }));
    }

    setCombatState(prev => ({
      ...prev,
      enemy: { ...prev.enemy, hp: newEnemyHp },
      log: [...prev.log.slice(-4), logMsg, enemyLog],
      turn: prev.turn + 1
    }));
  };

  // --- 界面渲染 ---

  return (
    <div className="min-h-screen bg-stone-950 text-stone-300 font-sans selection:bg-amber-900 selection:text-amber-100 flex flex-col md:flex-row overflow-hidden">
      
      {/* 侧边导航 Sidebar */}
      <nav className="w-full md:w-64 bg-stone-900 border-r border-amber-900/30 flex flex-col shrink-0">
        <div className="p-6 border-b border-amber-900/30 bg-stone-900/50">
          <h1 className="text-2xl font-serif font-bold text-amber-500 tracking-widest flex items-center gap-2">
            <Sparkles className="w-5 h-5" />
            凡人修仙
          </h1>
          <p className="text-xs text-stone-500 mt-1">Project Origin v1.0</p>
        </div>
        
        <div className="flex-1 overflow-y-auto py-4 space-y-1">
          <NavBtn active={view === "cave"} onClick={() => setView("cave")} icon={Mountain}>洞府打坐</NavBtn>
          <NavBtn active={view === "garden"} onClick={() => setView("garden")} icon={Leaf}>灵药园</NavBtn>
          <NavBtn active={view === "alchemy"} onClick={() => setView("alchemy")} icon={FlaskConical}>炼丹房</NavBtn>
          <NavBtn active={view === "explore"} onClick={() => setView("explore")} icon={MapIcon}>外出历练</NavBtn>
          <div className="border-t border-amber-900/20 my-2 mx-4"></div>
          <div className="px-4 py-2">
             <h3 className="text-xs font-bold text-stone-500 uppercase tracking-wider mb-2">储物袋</h3>
             <div className="space-y-2 text-sm text-stone-400">
               {Object.entries(player.inventory).map(([key, count]) => (
                 <div key={key} className="flex justify-between items-center bg-stone-800/50 px-2 py-1 rounded cursor-help" title={ITEMS[key].desc}>
                   <span>{ITEMS[key].name}</span>
                   <span className="text-amber-600 font-mono">x{count}</span>
                 </div>
               ))}
               {Object.keys(player.inventory).length === 0 && <span className="italic text-stone-600">空空如也</span>}
             </div>
             <div className="mt-4 flex justify-between items-center text-amber-400 font-bold">
               <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-amber-500"></div> 灵石</span>
               <span>{player.gold}</span>
             </div>
          </div>
        </div>
      </nav>

      {/* 主区域 Main Content */}
      <main className="flex-1 flex flex-col min-w-0 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
        
        {/* 顶部状态栏 Header Stats */}
        <header className="bg-stone-900/80 backdrop-blur border-b border-amber-900/30 p-4 flex flex-wrap gap-6 items-center shadow-lg z-10">
          <div className="flex items-center gap-3 min-w-[150px]">
             <div className="w-10 h-10 rounded-full bg-stone-800 border border-amber-700 flex items-center justify-center">
               <User className="w-6 h-6 text-amber-500" />
             </div>
             <div>
               <div className="text-stone-200 font-serif font-bold">{player.name}</div>
               <div className="text-amber-600 text-xs">{REALMS[player.realmIdx].name}</div>
             </div>
          </div>
          
          <div className="flex-1 grid grid-cols-2 md:grid-cols-3 gap-4">
            <ProgressBar value={player.hp} max={player.maxHp} color="bg-red-700" label="气血 (HP)" />
            <ProgressBar value={player.exp} max={REALMS[player.realmIdx].maxExp} color="bg-cyan-700" label="修为 (EXP)" />
            <div className="hidden md:block">
              <div className="flex justify-between text-xs mb-1 text-stone-400 font-serif">
                 <span>神识 (MP)</span>
                 <span>100%</span>
              </div>
              <div className="h-2 bg-stone-800 rounded-full border border-stone-700"><div className="h-full w-full bg-indigo-900"></div></div>
            </div>
          </div>
        </header>

        {/* 游戏视图区 Game View */}
        <div className="flex-1 overflow-y-auto p-4 md:p-8 relative">
          
          {/* 战斗遮罩层 */}
          {view === "combat" && combatState && (
             <div className="absolute inset-0 z-20 bg-stone-950/90 flex items-center justify-center p-4">
                <Card title={`遭遇战：${combatState.enemy.name}`} className="w-full max-w-2xl border-red-900/50">
                   <div className="flex justify-between items-end mb-8 px-4">
                      <div className="text-center">
                        <User className="w-12 h-12 mx-auto text-amber-500 mb-2" />
                        <div className="text-lg font-serif">{player.name}</div>
                        <div className="text-sm text-stone-400">HP: {player.hp}/{player.maxHp}</div>
                      </div>
                      <div className="text-2xl font-serif text-red-500 italic">VS</div>
                      <div className="text-center">
                        <Skull className="w-12 h-12 mx-auto text-red-500 mb-2 animate-pulse" />
                        <div className="text-lg font-serif text-red-200">{combatState.enemy.name}</div>
                        <div className="text-sm text-stone-400">HP: {combatState.enemy.hp}/{combatState.enemy.maxHp}</div>
                      </div>
                   </div>

                   <div className="bg-stone-900/50 h-32 overflow-y-auto p-2 mb-6 border border-stone-800 rounded text-sm space-y-1 font-mono">
                     {combatState.log.map((l, i) => <div key={i}>{l}</div>)}
                   </div>

                   <div className="grid grid-cols-2 gap-3">
                      <Button onClick={() => combatAction("attack")}><Swords className="w-4 h-4"/> 法器攻击</Button>
                      <Button onClick={() => combatAction("talisman")} variant="secondary"><Flame className="w-4 h-4"/> 符箓轰炸</Button>
                      <Button disabled className="opacity-50" variant="secondary">服用丹药</Button>
                      <Button onClick={() => combatAction("escape")} variant="danger"><Wind className="w-4 h-4"/> 风紧扯呼</Button>
                   </div>
                </Card>
             </div>
          )}

          {/* 正常视图 */}
          <div className="max-w-4xl mx-auto space-y-6">
            
            {view === "cave" && (
              <div className="grid md:grid-cols-2 gap-6">
                <Card title="洞府静室" className="h-64 flex flex-col items-center justify-center text-center space-y-4">
                   <div className="w-20 h-20 rounded-full bg-stone-800 border-4 border-stone-700 flex items-center justify-center relative">
                     <div className="absolute inset-0 rounded-full animate-ping opacity-10 bg-amber-500"></div>
                     <User className="w-10 h-10 text-stone-500" />
                   </div>
                   <div>
                     <p className="text-stone-400 text-sm mb-2">当前境界: <span className="text-amber-500">{REALMS[player.realmIdx].name}</span></p>
                     <Button onClick={meditate}>打坐修炼 (消耗时间)</Button>
                   </div>
                </Card>
                
                <Card title="神秘小瓶" className="h-64 flex flex-col items-center justify-center space-y-4 relative overflow-hidden">
                   <div className="absolute top-0 right-0 p-2 text-xs text-green-700 font-mono opacity-50">HEAVENLY BOTTLE</div>
                   <div className={`w-16 h-24 border-2 ${bottleCharge===100 ? 'border-green-400 shadow-[0_0_20px_rgba(74,222,128,0.5)]' : 'border-stone-600'} rounded-t-full rounded-b-xl relative bg-stone-800 flex items-end justify-center overflow-hidden transition-all duration-1000`}>
                     <div className="w-full bg-green-600/20 absolute bottom-0 transition-all duration-300" style={{ height: `${bottleCharge}%` }}></div>
                     {bottleCharge === 100 && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-green-400 animate-pulse"><Droplets /></div>}
                   </div>
                   <div className="text-center">
                     <div className="text-xs font-serif text-stone-500 mb-1">吸收月光精华中...</div>
                     <div className="text-2xl font-mono text-green-500">{bottleCharge}%</div>
                   </div>
                </Card>

                <Card title="背包物品" className="md:col-span-2">
                   <div className="flex flex-wrap gap-2">
                      {Object.keys(player.inventory).filter(k => ITEMS[k].type === "consumable").map(k => (
                        <button key={k} onClick={() => useItem(k)} className="px-3 py-1 bg-stone-800 border border-stone-600 rounded text-sm hover:border-amber-600 hover:text-amber-500 transition-colors">
                          使用 {ITEMS[k].name}
                        </button>
                      ))}
                      {Object.keys(player.inventory).filter(k => ITEMS[k].type === "consumable").length === 0 && <span className="text-stone-500 text-sm p-2">暂无可用丹药</span>}
                   </div>
                </Card>
              </div>
            )}

            {view === "garden" && (
              <Card title="灵药园" className="min-h-[400px]">
                <div className="flex justify-between items-center mb-6">
                  <p className="text-sm text-stone-400">在此处种植灵草。使用掌天瓶绿液可瞬间催熟。</p>
                  <Button variant="secondary" onClick={plantHerb} disabled={garden.length >= 4} className="text-sm">
                     <Leaf className="w-4 h-4"/> 开辟/种植
                  </Button>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {garden.map(plot => (
                    <div key={plot.id} className="aspect-square bg-stone-800/50 border border-stone-700 rounded-lg flex flex-col items-center justify-center p-4 relative group hover:border-amber-700/50 transition-colors">
                      <div className={`text-4xl mb-2 transition-transform duration-500 ${plot.progress === 100 ? 'scale-110 text-amber-500' : 'text-stone-600'}`}>
                        <Leaf />
                      </div>
                      <div className="text-sm font-serif">{plot.name}</div>
                      
                      {plot.progress < 100 ? (
                        <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-lg">
                           <Button onClick={() => ripenHerb(plot.id)} variant="primary" className="text-xs scale-90">
                             <Droplets className="w-3 h-3"/> 滴入绿液
                           </Button>
                        </div>
                      ) : (
                        <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-lg">
                           <Button onClick={() => harvestHerb(plot.id)} className="text-xs scale-90 bg-green-800 border-green-600 text-green-100">
                             收获
                           </Button>
                        </div>
                      )}
                    </div>
                  ))}
                  {[...Array(Math.max(0, 4 - garden.length))].map((_, i) => (
                    <div key={i} className="aspect-square bg-stone-900/30 border border-stone-800 border-dashed rounded-lg flex items-center justify-center text-stone-700">
                      <span className="text-xs">空置灵田</span>
                    </div>
                  ))}
                </div>
              </Card>
            )}

            {view === "alchemy" && (
              <div className="grid md:grid-cols-3 gap-6">
                <Card title="丹方列表" className="md:col-span-1 h-full">
                  <div className="space-y-2">
                    <div className="p-3 bg-stone-800/80 border-l-2 border-amber-600">
                      <div className="font-bold text-amber-500">黄龙丹</div>
                      <div className="text-xs text-stone-400 mt-1">功效: 增加修为</div>
                      <div className="text-xs text-stone-500 mt-1">需: 黄龙草 x2</div>
                    </div>
                    <div className="p-3 bg-stone-800/30 border-l-2 border-stone-700 opacity-50">
                      <div className="font-bold">筑基丹 (未掌握)</div>
                      <div className="text-xs text-stone-500 mt-1">???</div>
                    </div>
                  </div>
                </Card>
                <Card title="地火之屋" className="md:col-span-2 flex flex-col items-center justify-center text-center space-y-6">
                  <div className="relative">
                    <FlaskConical className="w-32 h-32 text-stone-600" strokeWidth={1} />
                    <div className="absolute bottom-0 left-0 right-0 h-1/3 bg-orange-600/20 blur-xl animate-pulse"></div>
                  </div>
                  <div>
                    <Button onClick={alchemy} className="w-48 py-3 text-lg">
                      <Flame className="w-5 h-5 animate-bounce" /> 开炉炼丹
                    </Button>
                    <p className="text-xs text-stone-500 mt-2">消耗: 黄龙草 x2</p>
                  </div>
                </Card>
              </div>
            )}

            {view === "explore" && (
               <Card title="大地图" className="min-h-[400px] flex flex-col items-center justify-center space-y-8 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                 <div className="grid grid-cols-3 gap-8 w-full max-w-lg px-8">
                    <LocationIcon label="彩霞山" active />
                    <LocationIcon label="太南坊市" />
                    <LocationIcon label="万蛇谷" danger />
                    <LocationIcon label="血色禁地" locked />
                    <LocationIcon label="天南" locked />
                    <LocationIcon label="乱星海" locked />
                 </div>
                 <div className="bg-stone-900/90 p-6 rounded-xl border border-stone-700 text-center max-w-md">
                    <h3 className="text-amber-500 font-bold mb-2">当前位置：彩霞山脉</h3>
                    <p className="text-sm text-stone-400 mb-6">此处灵气稀薄，多有野兽出没，偶有低阶散修经过。适合炼气期修士历练。</p>
                    <Button onClick={startExplore} className="w-full">
                       <MapIcon className="w-4 h-4"/> 开始探索
                    </Button>
                 </div>
               </Card>
            )}

          </div>
        </div>

        {/* 底部日志 Log Area */}
        <div className="h-32 bg-black border-t border-amber-900/30 p-2 font-mono text-xs overflow-y-auto text-stone-400 scroll-smooth">
           {logs.map((log, i) => (
             <div key={i} className="mb-1 border-l-2 border-stone-800 pl-2 hover:border-amber-800 hover:text-stone-200 transition-colors">
               {log}
             </div>
           ))}
           <div ref={logEndRef} />
        </div>
      </main>
    </div>
  );
}

// 辅助组件：侧边栏按钮
const NavBtn = ({ active, onClick, icon: Icon, children }) => (
  <button 
    onClick={onClick}
    className={`w-full text-left px-6 py-3 flex items-center gap-3 transition-all duration-300 font-serif
      ${active 
        ? 'bg-amber-900/20 text-amber-500 border-r-4 border-amber-600' 
        : 'text-stone-500 hover:bg-stone-800 hover:text-stone-300 border-r-4 border-transparent'
      }`}
  >
    <Icon className={`w-5 h-5 ${active ? 'text-amber-500' : 'text-stone-600'}`} />
    {children}
  </button>
);

// 辅助组件：地图图标
const LocationIcon = ({ label, active, danger, locked }) => (
  <div className={`flex flex-col items-center gap-2 ${locked ? 'opacity-30 grayscale' : 'cursor-pointer hover:-translate-y-1 transition-transform'}`}>
     <div className={`w-12 h-12 rounded-full flex items-center justify-center border-2 
       ${active ? 'bg-amber-900/30 border-amber-500 text-amber-500 shadow-[0_0_15px_rgba(245,158,11,0.3)]' : 
         danger ? 'bg-stone-900 border-red-900 text-red-800' : 'bg-stone-900 border-stone-700 text-stone-600'}`}>
       {locked ? <div className="text-xs">锁</div> : <Mountain size={20} />}
     </div>
     <span className={`text-xs font-serif font-bold ${active ? 'text-amber-500' : 'text-stone-500'}`}>{label}</span>
  </div>
);
